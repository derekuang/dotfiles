#!/usr/bin/env bash
{{ if eq .osid "linux-fedora" -}}

# 关闭SELinux
sudo sed -i 's|SELINUX=enforcing|SELINUX=disabled|g' /etc/selinux/config

# RPM Fushion源
if ! dnf repolist list | grep rpmfusion -q; then
    sudo dnf install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
    sudo dnf install https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
    sudo dnf config-manager setopt fedora-cisco-openh264.enabled=1
fi

# Terra软件源
if ! dnf repo list | grep terra -q; then
    sudo dnf install --nogpgcheck --repofrompath 'terra,https://repos.fyralabs.com/terra$releasever' terra-release
fi

# flathub仓库
sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak update --appstream

# copr第三方源
{{ range .packages.fedora.copr -}}
    if ! dnf copr list | grep {{ . }} -q; then
        sudo dnf copr enable {{ . }}
    fi
{{ end -}}

# google-chrome
if ! rpm -q --quiet google-chrome-stable; then
    sudo rpm --import https://dl.google.com/linux/linux_signing_key.pub
    sudo cp {{ .chezmoi.config.sourceDir -}}/system/yum.repos.d/google-chrome.repo /etc/yum.repos.d/
fi

# Resilio-Sync
if ! rpm -q --quiet resilio-sync; then
    sudo rpm --import https://linux-packages.resilio.com/resilio-sync/key.asc
    sudo cp {{ .chezmoi.config.sourceDir -}}/system/yum.repos.d/resilio-sync.repo /etc/yum.repos.d/
fi

# 刷新软件仓库
sudo dnf makecache

{{ end -}}
